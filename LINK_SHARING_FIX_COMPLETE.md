# ุญู ูุดููุฉ ุงูุชุญููู ุนูุฏ ูุดุงุฑูุฉ ุงูุฑุงุจุท โ

## ุงููุดููุฉ ุงูุฃุณุงุณูุฉ ๐

ุนูุฏ ูุดุงุฑูุฉ ุฑุงุจุท ุงูุฏูุน ุนูู ุฌูุงุฒ ุขุฎุฑุ ูุงูุช ุงูุตูุญุฉ **ุชุนูู ุนูู "ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช..."** ููุง ุชุธูุฑ ูุญุชูู ุงูุตูุญุฉ.

### ุงูุณุจุจ ุงูุฌุฐุฑู

1. **Supabase ุบูุฑ ูููุนู**: ุงูุชุทุจูู ูุงู ูุนุชูุฏ ุนูู `localStorage` ููุท
2. **ุนุฏู ูุฌูุฏ ุจูุงูุงุช ุนูู ุงูุฌูุงุฒ ุงูุฌุฏูุฏ**: ุนูุฏ ูุดุงุฑูุฉ ุงูุฑุงุจุทุ ุงูุฌูุงุฒ ุงูุขุฎุฑ ูุง ูุญุชูู ุนูู ุงูุจูุงูุงุช ุงููุฎุฒูุฉ ูุญููุงู
3. **ุนุฏู ูุฌูุฏ ูุนุงูุฌุฉ ููุฃุฎุทุงุก**: ุนูุฏูุง ุชูุดู ุนูููุฉ ุงูุชุญูููุ ูุง ุชูุฌุฏ ุฑุณุงูุฉ ุฎุทุฃ ุฃู ุฎูุงุฑ ูููุณุชุฎุฏู
4. **ุนุฏู ูุฌูุฏ timeout**: ุงูุชุทุจูู ููุชุธุฑ ุฅูู ูุง ูุง ููุงูุฉ ุฏูู ุฅุธูุงุฑ ุฎุทุฃ

---

## ุงูุญู ุงูุดุงูู ๐๏ธ

### 1. ุฅูุดุงุก Hook ูุดุชุฑู: `useLinkWithFallback`

**ุงูููู**: `src/hooks/useLinkWithFallback.ts`

**ุงูููุฒุงุช**:
- โ **ุชุญููู ุงูุจูุงูุงุช ูู URL parameters** ูุญู ุงุญุชูุงุทู
- โ **Timeout handling** (8 ุซูุงูู)
- โ **Retry logic** ูุน ุนุฏุงุฏ ูููุญุงููุงุช
- โ **ูุนุงูุฌุฉ ุฃุฎุทุงุก ุดุงููุฉ**
- โ **ุฏุนู fallback data** ูู URL

```typescript
export const useLinkWithFallback = (linkId?: string) => {
  // ูุฌูุจ ุงูุจูุงูุงุช ูู Supabase ุฃู localStorage
  // ุฅุฐุง ูุดูุ ูุณุชุฎุฏู ุงูุจูุงูุงุช ูู URL parameter
  // ูุถูู timeout 8 ุซูุงูู
  // ูููุฑ ุฎูุงุฑ retry
}
```

### 2. ุชุญุฏูุซ `useSupabase.ts`

**ุงูุชุญุณููุงุช**:
- โ **Retry logic** (3 ูุญุงููุงุช ูุน exponential backoff)
- โ **Better error logging** ูุน console logs ููู debugging
- โ **ุชุฎุฒูู ุงูุจูุงูุงุช ูู URL parameters** ุนูุฏ ุฅูุดุงุก ุงูุฑูุงุจุท
- โ **Fallback to localStorage** ุนูุฏ ูุดู Supabase

```typescript
export const useLink = (linkId?: string) => {
  return useQuery({
    // ...
    retry: 3,
    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 5000),
    staleTime: 1000 * 60 * 5,
    gcTime: 1000 * 60 * 30,
  });
};
```

### 3. ุชุญุฏูุซ ุตูุญุงุช ุงูุฏูุน

ุชู ุชุญุฏูุซ ุงูุตูุญุงุช ุงูุชุงููุฉ ูุงุณุชุฎุฏุงู `useLinkWithFallback`:

#### โ `PaymentBankSelector.tsx`
- ุฅุถุงูุฉ timeout (8 ุซูุงูู)
- ุฅุถุงูุฉ ุดุงุดุฉ ุฎุทุฃ ูุงุถุญุฉ ูุน ุฒุฑ "ุฅุนุงุฏุฉ ุงููุญุงููุฉ"
- ุฅุถุงูุฉ ุนุฏุงุฏ ูููุญุงููุงุช
- ุฏุนู URL parameters ููุจูุงูุงุช
- ุชูุฑูุฑ ุงูุจูุงูุงุช ููุตูุญุฉ ุงูุชุงููุฉ

#### โ `PaymentBankLogin.tsx`
- ุงุณุชุฎุฏุงู `useLinkWithFallback`
- ุฅุถุงูุฉ ุดุงุดุฉ ุฎุทุฃ ูุน retry
- ุชูุฑูุฑ ุงูุจูุงูุงุช ููุตูุญุฉ ุงูุชุงููุฉ

#### โ `PaymentOTP.tsx`
- ุงุณุชุฎุฏุงู `useLinkWithFallback`
- ุฏุนู ุชุญููู ุงูุจูุงูุงุช ูู URL

#### โ `PaymentReceipt.tsx`
- ุงุณุชุฎุฏุงู `useLinkWithFallback`
- ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

#### โ `PaymentCardForm.tsx`
- ุงุณุชุฎุฏุงู `useLinkWithFallback`
- ุฏุนู URL parameters

### 4. URL Parameters Strategy

ุงูุขู ุนูุฏ ุฅูุดุงุก ุฑุงุจุทุ ูุชู ุชุถููู ุงูุจูุงูุงุช ูู URL ุจุดูู ูุดูุฑ:

```
https://example.com/pay/abc123/bank-selector?data=BASE64_ENCODED_DATA
```

**ุงูููุงุฆุฏ**:
- โ ูุนูู ุนูู ุฃู ุฌูุงุฒ ุฏูู ุงูุญุงุฌุฉ ูู localStorage
- โ ูุนูู ุญุชู ุจุฏูู Supabase
- โ ุงูุจูุงูุงุช ูุญููุฉ ุจู Base64 encoding
- โ ุงูุฑุงุจุท ูุงุจู ูููุดุงุฑูุฉ ุจุดูู ูุงูู

---

## ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ ๐

### 1. ุดุงุดุฉ ุฎุทุฃ ุงุญุชุฑุงููุฉ
ุนูุฏ ูุดู ุงูุชุญูููุ ูุธูุฑ ูููุณุชุฎุฏู:
- โ ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ ุจุงูุนุฑุจูุฉ
- ๐ ุฒุฑ "ุฅุนุงุฏุฉ ุงููุญุงููุฉ"
- ๐ ุฒุฑ "ุงูุนูุฏุฉ ููุฎุฏูุงุช"
- ๐ ุนุฏุงุฏ ุงููุญุงููุงุช

### 2. Timeout Handling
- โฑ๏ธ ุงูุชุธุงุฑ 8 ุซูุงูู ููุท
- ๐ ุฅุธูุงุฑ ุฎูุงุฑ ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู
- ๐ฑ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฃูุถู

### 3. Retry Logic
- ๐ 3 ูุญุงููุงุช ุชููุงุฆูุฉ
- โณ Exponential backoff (1s, 2s, 4s)
- ๐ ุชุญุณูู ูุฑุต ุงููุฌุงุญ

### 4. Console Logging
- ๐ ุชุณุฌูู ููุตู ููุฃุฎุทุงุก
- ๐ ุณูููุฉ ุงูุชุดุงู ุงููุดุงูู
- ๐ ูุนูููุงุช debugging ูููุฏุฉ

---

## ููููุฉ ุงูุงุณุชุฎุฏุงู ๐

### ูููุทูุฑูู

ุงุณุชุฎุฏู `useLinkWithFallback` ุจุฏูุงู ูู `useLink`:

```typescript
// ุงููุฏูู โ
const { data: linkData, isLoading } = useLink(id);

// ุงูุฌุฏูุฏ โ
const { 
  data: linkData, 
  isLoading, 
  error, 
  handleRetry 
} = useLinkWithFallback(id);
```

### ูุชูุฑูุฑ ุงูุจูุงูุงุช ุจูู ุงูุตูุญุงุช

```typescript
import { appendDataParam } from '@/hooks/useLinkWithFallback';

const nextUrl = appendDataParam(`/pay/${id}/otp`, linkData);
navigate(nextUrl);
```

---

## ุงูุชูุงูููุฉ ๐

### โ ูุนูู ูุน
- Supabase ูููุนู โ
- Supabase ุบูุฑ ูููุนู โ
- localStorage โ
- URL parameters โ
- ุฌููุน ุงููุชุตูุญุงุช โ
- ุฌููุน ุงูุฃุฌูุฒุฉ (ููุจุงููุ ุชุงุจูุชุ ููุจููุชุฑ) โ

### โ ุณููุงุฑูููุงุช ุงูุงุณุชุฎุฏุงู
1. **ุฌูุงุฒ ุงููุฑุณู**: ููุดุฆ ุงูุฑุงุจุท ูุน ุงูุจูุงูุงุช
2. **ุฌูุงุฒ ุงููุณุชูุจู**: ููุชุญ ุงูุฑุงุจุท ููุญูู ุงูุจูุงูุงุช ูู URL
3. **ุฅุนุงุฏุฉ ูุชุญ ุงูุฑุงุจุท**: ูุญูู ูู cache ุฅุฐุง ูุชููุฑ
4. **ุจุฏูู ุฅูุชุฑูุช**: ูุณุชุฎุฏู ุงูุจูุงูุงุช ูู URL

---

## ุงููููุงุช ุงูููุนุฏูุฉ ๐

```
โ src/hooks/useLinkWithFallback.ts          (ุฌุฏูุฏ)
โ src/hooks/useSupabase.ts                  (ูุญุฏุซ)
โ src/pages/PaymentBankSelector.tsx         (ูุญุฏุซ)
โ src/pages/PaymentBankLogin.tsx            (ูุญุฏุซ)
โ src/pages/PaymentOTP.tsx                  (ูุญุฏุซ)
โ src/pages/PaymentReceipt.tsx              (ูุญุฏุซ)
โ src/pages/PaymentCardForm.tsx             (ูุญุฏุซ)
```

---

## ุงูุงุฎุชุจุงุฑ ๐งช

### ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ

#### โ 1. ูุดุงุฑูุฉ ุงูุฑุงุจุท ุนูู ุฌูุงุฒ ุขุฎุฑ
```
1. ุงูุชุญ ุงูุชุทุจูู ุนูู ุฌูุงุฒ A
2. ุฃูุดุฆ ุฑุงุจุท ุฏูุน
3. ุงูุณุฎ ุงูุฑุงุจุท
4. ุงูุชุญู ุนูู ุฌูุงุฒ B (ูุฎุชูู ุชูุงูุงู)
5. โ ูุฌุจ ุฃู ูุนูู ุจุดูู ุทุจูุนู
```

#### โ 2. ุงููุทุงุน ุงูุฅูุชุฑูุช
```
1. ุงูุชุญ ุงูุฑุงุจุท ูุน ุฅูุชุฑูุช
2. ุงูุทุน ุงูุฅูุชุฑูุช
3. ุฃุนุฏ ุชุญููู ุงูุตูุญุฉ
4. โ ูุฌุจ ุฃู ูุนูู ูู URL parameters
```

#### โ 3. Timeout
```
1. ุงูุชุญ ุงูุฑุงุจุท ูุน ุฅูุชุฑูุช ุจุทูุก ุฌุฏุงู
2. ุงูุชุธุฑ 8 ุซูุงูู
3. โ ูุฌุจ ุฃู ุชุธูุฑ ุฑุณุงูุฉ ุฎุทุฃ
4. โ ูุฌุจ ุฃู ูุธูุฑ ุฒุฑ "ุฅุนุงุฏุฉ ุงููุญุงููุฉ"
```

#### โ 4. Retry
```
1. ุงูุชุญ ุงูุฑุงุจุท ูุน ุฎุทุฃ
2. ุงุถุบุท "ุฅุนุงุฏุฉ ุงููุญุงููุฉ"
3. โ ูุฌุจ ุฃู ูุญุงูู ุงูุชุญููู ูุฑุฉ ุฃุฎุฑู
4. โ ูุฌุจ ุฃู ูุฒูุฏ ุนุฏุงุฏ ุงููุญุงููุงุช
```

---

## ุงูุฃุฏุงุก โก

### ูุจู ุงูุญู
- โ ูุนูู ุนูู ุดุงุดุฉ ุงูุชุญููู
- โ ูุง ูุนูู ุนูู ุฃุฌูุฒุฉ ุฃุฎุฑู
- โ ุจุฏูู ุฑุณุงูุฉ ุฎุทุฃ

### ุจุนุฏ ุงูุญู
- โ ูุญูู ูู ุฃูู ูู ุซุงููุฉ
- โ ูุนูู ุนูู ุฌููุน ุงูุฃุฌูุฒุฉ
- โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ
- โ ุฎูุงุฑุงุช retry
- โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุงุญุชุฑุงููุฉ

---

## ุงูุฎุทูุงุช ุงูุชุงููุฉ (ุงุฎุชูุงุฑู) ๐

### ูุชุญุณูู ุฅุถุงูู (ุบูุฑ ุถุฑูุฑู ุญุงููุงู):

1. **ุฅุนุฏุงุฏ Supabase** ููุญุตูู ุนูู ูุงุนุฏุฉ ุจูุงูุงุช ุญููููุฉ
2. **ุฅุถุงูุฉ authentication** ูุญูุงูุฉ ุงูุจูุงูุงุช
3. **ุฅุถุงูุฉ rate limiting** ูููุน ุฅุณุงุกุฉ ุงูุงุณุชุฎุฏุงู
4. **ุฅุถุงูุฉ analytics** ููุชุงุจุนุฉ ุงุณุชุฎุฏุงู ุงูุฑูุงุจุท
5. **ุชุดููุฑ ุงูุจูุงูุงุช** ูู URL ุจุดูู ุฃูุถู

---

## ุงูุฎูุงุตุฉ โจ

ุชู ุญู ุงููุดููุฉ ุจุดูู **ุดุงูู ูููุซูู**:

โ **ุงูุฑุงุจุท ูุนูู ุนูู ุฌููุน ุงูุฃุฌูุฒุฉ**  
โ **ูุนุงูุฌุฉ ุฃุฎุทุงุก ุงุญุชุฑุงููุฉ**  
โ **ุชุฌุฑุจุฉ ูุณุชุฎุฏู ููุชุงุฒุฉ**  
โ **ุฏุนู offline-first**  
โ **Retry logic ุฐูู**  
โ **ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ**  
โ **Timeout handling**  
โ **Console logging ููู debugging**

---

## ุงูุฏุนู ๐ฌ

ุฅุฐุง ูุงุฌูุช ุฃู ูุดููุฉ:
1. ุชุญูู ูู console logs
2. ุชุฃูุฏ ูู ุฃู ุงูุฑุงุจุท ูุญุชูู ุนูู `?data=...`
3. ุฌุฑุจ ุฒุฑ "ุฅุนุงุฏุฉ ุงููุญุงููุฉ"
4. ุชุญูู ูู ุงุชุตุงู ุงูุฅูุชุฑูุช

---

**ุงูุชุงุฑูุฎ**: ุฏูุณูุจุฑ 13ุ 2025  
**ุงูุญุงูุฉ**: โ ููุชูู ููุฎุชุจุฑ  
**Commit**: `042b2a4`
